<script>
    lottie.loadAnimation({
        container: document.getElementById('help-lottie'),
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: './assets/animations/otp-lock.json'
    })
</script>
<script>
    function showAlert(title, message, type) {
        if (title) {
            Swal.fire({
                title: title,
                text: message,
                icon: type,
                confirmButtonText: 'Close'
            })
        } else {
            Swal.fire({
                text: message,
                icon: type,
                confirmButtonText: 'Close'
            })
        }
    }

    $(document).ready(function() {
        $('.forgot_type').change(function() {
            const selectedValue = $(this).val()
            if (selectedValue === '1') {
                $('.forgot-password').addClass('d-none')
                $('.forgot-account').removeClass('d-none')
            } else if (selectedValue === '2') {
                $('.forgot-password').removeClass('d-none')
                $('.forgot-account').addClass('d-none')
            }
        })

        $('#captcha_change').click(() => {
            $.post({
                url: './home/changeCaptchaImage',
                method: 'POST',
                data: {},
                dataType: 'json',
                success: function(res) {
                    $('#help_captcha_image').html(res.iamge)
                }
            })
        })

        $("#submit").click(function () {
            const params = {
                help_type: $("#forgot_account").prop("checked") === true ? "account" : "password",
                first_name: $("#first_name").val(),
                last_name: $("#last_name").val(),
                dob: $("#dob").val(),
                email: $("#email").val(),
                captcha: $("#captcha").val()
            }
            
            if (params.help_type === "account") {
                if (!params.first_name) {
                    const input = document.getElementById('fname-container')
                    input.classList.remove('shake')
                    void input.offsetWidth // <== Force reflow
                    input.classList.add('shake')

                    input.focus()
                    return
                }
                if (!params.last_name) {
                    const input = document.getElementById('lname-container')
                    input.classList.remove('shake')
                    void input.offsetWidth // <== Force reflow
                    input.classList.add('shake')

                    input.focus()
                    return
                }
                if (!params.dob) {
                    const input = document.getElementById('dob-container')
                    input.classList.remove('shake')
                    void input.offsetWidth // <== Force reflow
                    input.classList.add('shake')

                    input.focus()
                    return
                }
            } else if (params.help_type === "password") {
                if (!params.email) {
                    const input = document.getElementById('email-container')
                    input.classList.remove('shake')
                    void input.offsetWidth // <== Force reflow
                    input.classList.add('shake')

                    input.focus()
                    return
                }
                if (!params.captcha) {
                    const input = document.getElementById('captcha-container')
                    input.classList.remove('shake')
                    void input.offsetWidth // <== Force reflow
                    input.classList.add('shake')

                    input.focus()
                    return
                }
            }

            $.post({
                url: "./confirmHelp",
                data: params,
                dataType: "json",
                success: function (res) {
                    if (res.status === "success") {
                        window.location.href = res.url
                    } else {
                        if (res.error === "captcha") {
                            $("#help_captcha_image").html(res.captcha)
                        }
                        $("#alert-message").removeClass("shake")
                        $("#alert-message").html(res.error_message)
                        $("#alert-message").addClass("shake")
                        $("#alert-message").removeClass("d-none")
                    }
                }, error: function (xhr, status, error) {
                    showAlert("", "<%= component_text.t_pa_ah_alert_failed %>", "error")
                }
            })
        })

    })
</script>