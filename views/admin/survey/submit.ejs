<!DOCTYPE html>
<html lang="en">

<%
    function dateDifference(startDate, endDate) {
        // calculatig the difference in timestamps
        const s = new Date(strDate)
        const e = new Date(endDate)
        const d = s - e
        return Math.ceil(Math.abs(d / 86400))
    }
%>

<%- include('../header') %>
<head>
    <link href="<%= site_url + prefix %>/assets/admin//css/material-bootstrap-wizard.css" rel="stylesheet" />
    <style>
        p{
            font-size: 20px;
            font-weight: 500;
        }
        .expired-text{
            font-weight: 500;
        }
        .wizard-card {
            box-shadow: none!important;
        }
        .form-check-label {
            font-size: 17px;
        }
        .circle {
            top: 5px !important;
        }
        .form-check-radio {
            padding-left: 6px;
            border: 1px solid rgba(0, 0, 0, .54);
        }
    </style>
</head>

<body>
    <div class="wrapper ">
        <div class="main-panel" style="width:100%">
            <div class="content mt-0">
                <div class="container-fluid">
                    <div class="container">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12 text-center">
                                        <img src="<%= site_url %>/assets/images/logo.png" alt="" width="200" />
                                    </div>

                                    <input type="hidden" id="surveyid"  value = "<%= id %>" />
                                    <div class="col-md-12 text-center mt-2 mb-1" style="font-size: 1.125rem; font-weight: bold;">
                                        <span><%= result.sub %></span>
                                    </div>
                                    <% if (dateDifference(result.created, new Date(Date.now())) <= 14) { %>
                                        <div class="col-md-12 text-center mt-1 mb-1" style="font-size: 1.125rem; font-weight: bold;">
                                            <span id="step-number">1</span>
                                            <span>/</span>
                                            <span><%= result.quiz.length %></span>
                                        </div>
                                        <div class="col-md-12 text-center">
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mt-5">
                                            <div class="wizard-container pt-0">
                                                <div class="wizard-card" data-color="primary" id="wizardProfile">
                                                    <div style="display:none" class="wizard-navigation no-print">
                                                        <ul style="line-height: 40px;">
                                                            <% for (let i = 0; i < result.quiz.length; i ++) { %>
                                                                <li><a href="#step<%= i %>" data-toggle="tab">STEP <%= i + 1 %></a></li>
                                                            <% } %>
                                                        </ul>
                                                    </div>
                                                    <div class="tab-content">
                                                        <% for (let i = 0; i < result.quiz.length; i ++) { %>
                                                            <div class="tab-pane" id="step<%= i %>">
                                                                <form>  
                                                                    <p class="mt-4 quiztag" key="<%= result.quiz[i].id %>"><%= result.quiz[i].quiz %></p>
                                                                    <% const tempResArr = result.res[i].res.split(",") %>
                                                                    <% if (tempResArr.length === 1 && tempResArr[0] == "") { %>
                                                                        <div class="restag" key="<%= result.res[i].id %>">
                                                                            <textarea class="form-control resvalue" rows="3"></textarea>
                                                                        </div>
                                                                    <% } else {  %>
                                                                        <div class="restag" key="<%= result.res[i].id %>">
                                                                            <% for (let j = 0; j < tempResArr.length; j ++) { %>
                                                                                <div class="form-check form-check-radio">
                                                                                    <label class="form-check-label">
                                                                                        <input class="form-check-input resvalue" value="<%= j %>" type="radio" name="<%= result.quiz[i].id %> + '_' + <%= result.res[i].id %> + '_option'" /><%= tempResArr[j] %>
                                                                                        <span class="circle">
                                                                                            <span class="check"></span>
                                                                                        </span>
                                                                                    </label>
                                                                                </div>
                                                                            <% } %>
                                                                        </div>
                                                                    <% } %>
                                                                </form>  
                                                            </div>
                                                        <% } %>
                                                    </div>
                                                    <div class="wizard-footer">
                                                        <div class="pull-right">
                                                            <input type='button' class='btn btn-next btn-fill btn-info btn-wd' name='next' value='Next' />
                                                            <input type='submit' class='btn btn-finish btn-fill btn-success btn-wd submitbtn' name='finish' value='Submit' />
                                                        </div>
                                                        <div class="pull-left">
                                                            <input type='button' class='btn btn-previous btn-fill btn-danger btn-wd' name='previous' value='Previous' />
                                                        </div>
                                                        <div class="clearfix"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <% } else { %>
                                        <div class="col-md-12 text-center mt-5">
                                            <h4 class="text-center expired-text"><?php echo $langs[array_search('t_survey_expired', array_column($langs, 'keyvalue'))]['lang'] ?></h4>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</body>

<script src="<%= site_url + prefix %>/assets/admin//js/bootstrap.min.js" type="text/javascript"></script>
<script src="<%= site_url + prefix %>/assets/admin//js/jquery.bootstrap.js" type="text/javascript"></script>
<script src="<%= site_url + prefix %>/assets/admin//js/material-bootstrap-wizard.js"></script>
<script src="<%= site_url + prefix %>/assets/admin//js/jquery.validate.min.js"></script>

<script>
    var quizCount = "<%= result.quiz.length %>"

    getStepNumber()

    function getStepNumber() {
        setTimeout(function () {
            var pane_list = $('.tab-pane')
            var stepNumber = 0
            for (let i = 0; i < pane_list.length; i++) {
                if ($(pane_list[i]).hasClass('active')) {
                    stepNumber = i+1
                    break
                }
            }
            $('#step-number').html(stepNumber)
            var width = parseInt((stepNumber - 1) * 100 /quizCount)
            $('.progress-bar').css('width', width + '%')
        }, 300)

    }

    $(".submitbtn").click(function() {
        var questionArr = []
        var responseArr = []
        var responsevalueArr = []
        for (var i = 0; i < $(".quiztag").length; i++) {
            questionArr.push($($(".quiztag")[i]).attr("key"))
            responseArr.push($($(".restag")[i]).attr("key"))
            if($($(".restag")[i]).find(".resvalue").length == 1) {
                responsevalueArr.push($($(".restag")[i]).find(".resvalue").val())
            } else {
                responsevalueArr.push($($(".restag")[i]).find(".resvalue:checked").val())
            }
        }
        $('body').append("<form id='surveysubmitform' action='<%= site_url + prefix %>/surveys/result' method='post' target='_blank'><input type='hidden' name='id' value='" + $("#surveyid").val()+"' /><input type='hidden' name='quiz' value='"+JSON.stringify(questionArr)+"' /><input type='hidden' name='res' value='"+JSON.stringify(responseArr)+"' /><input type='hidden' name='value' value='"+JSON.stringify(responsevalueArr)+"' /></form>")
        $('#surveysubmitform').submit()
        window.close()
    })

    $(".btn-next").click(function() {
        getStepNumber()
    })

    $(".btn-previous").click(function() {
        getStepNumber()
    })

</script>

</html>
